#!/bin/bash
PATH=$(gobin -m -p \
	github.com/bufbuild/buf/cmd/buf \
	github.com/golangci/golangci-lint/cmd/golangci-lint \
	github.com/googleapis/api-linter/cmd/api-linter \
	github.com/powerman/dockerize \
	gotest.tools/gotestsum |
	xargs dirname | sed -z -e 's/\n/:/g')$PATH
set -x -e -o pipefail

hadolint Dockerfile

shellcheck env.sh.dist scripts/*

if test -d api/proto; then
	git show-branch master >/dev/null
	! git ls-tree -r master api/proto | grep -q '[.]proto$' ||
		! find api/proto -name '*.proto' -print -quit 2>/dev/null | grep -q . ||
		buf check breaking --against '.git#branch=master'

	buf check lint

	# shellcheck disable=SC2046 # $(sed) needs to output multiple words.
	find api/proto -name '*.proto' -print0 2>/dev/null | xargs -0 --no-run-if-empty -n 1 \
		api-linter --set-exit-status --config .api-linter.yml \
		$(sed -n -e '/roots:/,/:$/{s/^\s*- /-I /p}' buf.yaml)
fi

# When https://github.com/quasilyte/go-ruleguard/issues/78 will be
# implemented and available in golangci-lint then replace using
# build/gorules/rules.go.
mod="$(go list -m)"
(! grep --color=auto -r "\"$mod/internal" pkg)
find ms -type d -name old | while read -r old; do
	# shellcheck disable=SC2251 # Need inverted exit status to keep -e happy.
	! grep -P -r "\"$mod/${old%/*}/(?!old|app)" "$old"
done

golangci-lint run

dockerize \
	-wait "tcp://${MONO_X_MYSQL_ADDR_HOST}:${MONO_X_MYSQL_ADDR_PORT:-3306}" \
	-wait "tcp://${MONO_X_POSTGRES_ADDR_HOST}:${MONO_X_POSTGRES_ADDR_PORT:-5432}" \
	-timeout 30s
test -z "$CI" || scripts/postgres-setup | docker run -i --rm --net=host \
	-e PGHOST -e PGPORT -e PGUSER -e PGPASSWORD -e PGDATABASE --entrypoint=psql postgres:11.10
gotestsum -- -race -tags=integration "$@" ./...
